---

.molecule:
  tags:
    - packet
  extends: .testcases
  only: [/^pr-.*$/]
  except: ['triggers']
  services: []
  stage: deploy-part1
  script:
    - ./tests/scripts/molecule_run.sh
  after_script:
    - chronic ./tests/scripts/molecule_logs.sh
  artifacts:
    when: always
    paths:
      - molecule_logs/
  variables:
    ANSIBLE_TIMEOUT: "120"
    CI_PLATFORM: packet
    SSH_USER: kubespray

# CI template for periodic CI jobs
# Enabled when PERIODIC_CI_ENABLED var is set
.molecule_periodic:
  only:
    variables:
      - $PERIODIC_CI_ENABLED
  allow_failure: true
  extends: .molecule

molecule_full:
  extends: .molecule_periodic

molecule_no_container_engines:
  extends: .molecule
  script:
    - ./tests/scripts/molecule_run.sh -e container-engine
  when: on_success

molecule_docker:
  extends: .molecule
  script:
    - ./tests/scripts/molecule_run.sh -i container-engine/cri-dockerd
  when: manual

molecule_containerd:
  extends: .molecule
  script:
    - ./tests/scripts/molecule_run.sh -i container-engine/containerd
  when: manual

molecule_cri-o:
  extends: .molecule
  stage: deploy-part2
  script:
    - ./tests/scripts/molecule_run.sh -i container-engine/cri-o
  allow_failure: true
  when: manual

# Stage 3 container engines don't get as much attention so allow them to fail
molecule_kata:
  extends: .molecule
  stage: deploy-part3
  script:
    - ./tests/scripts/molecule_run.sh -i container-engine/kata-containers
  when: manual
# FIXME: this test is broken (perma-failing)

molecule_gvisor:
  extends: .molecule
  stage: deploy-part3
  script:
    - ./tests/scripts/molecule_run.sh -i container-engine/gvisor
  when: manual
# FIXME: this test is broken (perma-failing)

molecule_youki:
  extends: .molecule
  stage: deploy-part3
  script:
    - ./tests/scripts/molecule_run.sh -i container-engine/youki
  when: manual
# FIXME: this test is broken (perma-failing)
