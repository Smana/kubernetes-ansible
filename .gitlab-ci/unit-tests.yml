---
unit-tests:
  extends: .job
  stage: unit-tests
  variables:
    SHELLCHECK_VERSION: v0.6.0
    ANSIBLE_INVENTORY: inventory/local-tests.cfg
    ANSIBLE_REMOTE_USER: root
    ANSIBLE_BECOME: "true"
    ANSIBLE_BECOME_USER: root
    ANSIBLE_VERBOSITY: "3"
  script:
    - /usr/bin/python -m pip install -r tests/requirements.txt
    - curl --silent "https://storage.googleapis.com/shellcheck/shellcheck-"${SHELLCHECK_VERSION}".linux.x86_64.tar.xz" | tar -xJv
    - cp shellcheck-"${SHELLCHECK_VERSION}"/shellcheck /usr/bin/
    - echo "* -> VERSION CHECK"
    - shellcheck --version
    - ansible-lint --version
    - yamllint --version
    - echo "* -> YAMLLINT"
    - yamllint --strict .
    - echo "* -> SHELLCHECK"
    - find . -name '*.sh' -not -path './contrib/*' | xargs shellcheck --severity error
    - echo "* -> SYNTAX-CHECK"
    - ansible-playbook --syntax-check cluster.yml
    - ansible-playbook --syntax-check upgrade-cluster.yml
    - ansible-playbook --syntax-check reset.yml
    - ansible-playbook --syntax-check extra_playbooks/upgrade-only-k8s.yml
    - echo "* -> ANSIBLE-LINT"
    - |-
      grep -Rl '^- hosts: \|^  hosts: \|^- name: ' --include \*.yml --include \*.yaml . | xargs ansible-lint -v
  except: ['triggers', 'master']

tox-inventory-builder:
  stage: unit-tests
  extends: .job
  script:
    - pip install tox
    - cd contrib/inventory_builder && tox
  when: manual
  except: ['triggers', 'master']
