---
- name: upload | Save and compress image
  shell: "{{ docker_bin_dir }}/docker save {{ download_facts.pull_name }} | gzip -{{ download_compress }} > {{ upload_from_path }}"
  delegate_to: "{{ upload_from }}"
  register: container_save_status
  failed_when: container_save_status.stderr
  become: false
  when:
  - download.container
  - ansible_os_family not in ["CoreOS", "Container Linux by CoreOS"]

- name: upload | Create node cache directory
  file:
    path: "{{ download_facts.node_cache_path | dirname }}"
    state: directory
    recurse: yes
  become: false

- name: upload | Upload file/image to node
  synchronize:
    src: "{{ upload_from_path }}"
    dest: "{{ download_facts.node_cache_path }}"
    use_ssh_args: "{{ has_bastion | default(false) }}"
    mode: push
  delegate_to: "{{ upload_from }}"
  become: false
  register: get_task
  until: get_task is succeeded
  retries: 4
  delay: "{{ retry_stagger | random + 3 }}"
  when:
  - ansible_os_family not in ["CoreOS", "Container Linux by CoreOS"]
