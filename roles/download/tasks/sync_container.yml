---
- block:
  - name: sync_container | Upload container image to node
    synchronize:
      src: "{{ download_facts.cache_path }}"
      dest: "{{ download_facts.dest }}"
      use_ssh_args: "{{ has_bastion | default(false) }}"
      mode: push
    delegate_facts: no
    register: get_task
    become: true
    until: get_task is succeeded
    retries: 4
    delay: "{{ retry_stagger | random + 3 }}"
    when:
    - ansible_os_family not in ["CoreOS", "Container Linux by CoreOS"]

  - name: sync_container | Load container image into docker
    shell: "{{ docker_bin_dir }}/docker load < {{ download_facts.dest }}"
    when:
    - ansible_os_family not in ["CoreOS", "Container Linux by CoreOS"]

  - name: sync_container | Remove container image from cache
    file:
      state: absent
      path: "{{ download_facts.dest }}"
    when:
    - not download_keep_remote_cache
    - ansible_os_family not in ["CoreOS", "Container Linux by CoreOS"]

  tags:
  - upload
