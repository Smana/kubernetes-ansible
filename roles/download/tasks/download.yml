---
- delegate_to: "{{ download_delegate if download_delegate | length > 0 else inventory_hostname }}"
  run_once: "{{ download_delegate | length > 0 }}"
  block:
  - name: download | Create download path directory
    file:
      path: "{{ download_facts.download_path | dirname }}"
      mode: 0755
      state: directory
      recurse: yes
    become: "{{ not download_delegate | length > 0 }}"

  - name: download | Download file
    get_url:
      url: "{{ download.url }}"
      dest: "{{ download_facts.download_path }}"
      owner: "{{ omit if download_delegate else (download.owner | default(omit)) }}"
      mode: "{{ omit if download_delegate else (download.mode | default(omit)) }}"
      checksum: "{{ 'sha256:' + download.sha256 if download.sha256 or omit }}"
      validate_certs: "{{ download_validate_certs }}"
      url_username: "{{ download.username | default(omit) }}"
      url_password: "{{ download.password | default(omit) }}"
      force_basic_auth: "{{ download.force_basic_auth | default(omit) }}"
    register: get_url_result
    become: "{{ not download_delegate | length > 0 }}"
    until: "'OK' in get_url_result.msg or 'file already exists' in get_url_result.msg"
    retries: 4
    delay: "{{ retry_stagger | default(5) }}"
    when:
    - download.file

  # NOTE: Pre-loading docker images will not prevent 'docker pull' from re-downloading the layers in that image
  # if a pull is forced. This is a known issue with docker. See https://github.com/moby/moby/issues/23684
  - name: download | Download image if required
    command: "{{ image_pull_command }} {{ download_facts.pull_name }}"
    register: pull_task_result
    until: pull_task_result is succeeded
    delay: "{{ retry_stagger | random + 3 }}"
    retries: 4
    become: "{{ user_can_become_root | default(false) or not (download_delegate | length > 0) }}"
    when:
    - download.container

  - name: download | Check if download changed
    set_fact:
      download_changed: >-
        {%- if download.file -%}
          {{ get_url_result.changed }}
        {%- elif download.container -%}
          {{ true if pull_task_result.stdout is defined and not 'up to date' in pull_task_result.stdout else false }}
        {%- endif -%}
    tags:
    - facts
