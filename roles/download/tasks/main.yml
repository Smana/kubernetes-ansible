---
- name: download | Prepare working directories and variables
  import_tasks: prep_download.yml
  when:
  - not skip_downloads|default(false)
  tags:
  - download
  - upload

- include_tasks: ../../container-engine/containerd/tasks/crictl.yml
  when:
  - not skip_downloads|default(false)
  - container_manager in ['containerd', 'crio']

- name: download | Get kubeadm binary and list of required images
  include_tasks: prep_kubeadm_images.yml
  when:
  - not skip_downloads|default(false)
  - inventory_hostname in groups['kube-master']
  - not skip_kubeadm_images | default(false)
  tags:
  - download
  - upload

- name: Start download and sync process
  vars:
    download: "{{ download_defaults | combine(item.value) }}"
  include_tasks: process.yml
  with_dict: "{{ downloads | combine(kubeadm_images) }}"
  when:
  - not skip_downloads | default(false)
  - download.enabled
  - item.value.enabled
  - (not (item.value.container | default(false))) or (item.value.container and download_container)
  - group_names | intersect(download.groups) | length

- name: Clean download directory (delegate)
  file:
    path: "{{ download_dir }}"
    state: absent
  delegate_to: "{{ download_delegate }}"
  when:
  - download_delegate | length > 0
  - download_delegate != download_cache_host or download_dir != download_cache_dir

- name: Clean node cache
  file:
    path: "{{ download_node_cache_dir }}"
    state: absent
  when:
  - not (download_node_cache | default(false))
  - not skip_downloads | default(false)
