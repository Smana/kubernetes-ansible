---
- name: download gitlab-runner script
  get_url:
    url: https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh
    dest: /tmp/script.deb.sh
    mode: 0555

- name: Execute gitlab-runner script
  shell: /tmp/script.deb.sh

- name: Pin the gitlab-runner package to the packages.gitlab.com repo
  template: 
    src: pin-gitlab-runner.pref.j2
    dest: /etc/apt/preferences.d/pin-gitlab-runner.pref
    owner: root
    mode: 0640

- name: Install specific version of GitLab runner
  apt:
    name: gitlab-runner=10.3.0
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Add gitlab-runneritlab-runner user to docker group
  user:
    name: gitlab-runner
    groups: docker

- name: Install python pip
  apt:
    name: python-pip 
  when: ansible_os_family == "Debian"

- name: Uninstall docker-py
  pip:
    name: docker-py
    state: absent
  
- name: Install docker docker library
  pip:
    name: docker
    state: forcereinstall


- name: install docker-compose
  pip:
    name: docker-compose

- name: download Node.js setup script
  get_url:
    url: https://deb.nodesource.com/setup_8.x
    dest: /tmp/setup_8.x
    mode: 0555

- name: Execute Node.js setup script
  shell: sudo -E bash /tmp/setup_8.x

- name: Install nodejs
  apt:
    name: nodejs
    update_cache: yes

- name: Configure the Yarn APT key
  apt_key:
    url: https://dl.yarnpkg.com/debian/pubkey.gpg
    state: present
  
- name: Add Yarn repository
  apt_repository:
    repo: 'deb https://dl.yarnpkg.com/debian/ stable main'
    state: present

- name: Install yarn
  apt:
    name: yarn
    update_cache: yes

- name: Install awscli
  apt: 
    name: awscli

- name: Set global options
  include: global-setup.yml
  
- name: Register GitLab Runner
  include: register-runner.yml
  when: gitlab_runner_registration_token != ''
  