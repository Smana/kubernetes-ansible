---
- name: Check if secret for encrypting data at rest already exist
  stat:
    path: "{{ kube_cert_dir }}/secrets_encryption.yaml"
  register: secrets_encryption_file

- name: Slurp secrets_encryption file if it exists
  slurp:
    src: "{{ kube_cert_dir }}/secrets_encryption.yaml"
  register: secret_file_encoded
  when: secrets_encryption_file.stat.exists

- name: Base 64 Decode slurped secrets_encryption file
  set_fact:
    secret_file_decoded: "{{secret_file_encoded['content'] | b64decode | from_yaml}}"
  when: secrets_encryption_file.stat.exists

- name: Query for secret value
  set_fact:
    kube_encrypt_token: "{{ secret_file_decoded | json_query(secrets_encryption_query) | first | b64decode}}"
  when: secrets_encryption_file.stat.exists

- name: Write secrets for encrypting secret data at rest
  template:
    src: secrets_encryption.yaml.j2
    dest: "{{ kube_cert_dir }}/secrets_encryption.yaml"
    owner: root
    group: "{{ kube_cert_group }}"
    mode: 0640
  tags:
    - kube-apiserver
