---
- include: pre-upgrade.yml

- name: Copy kubectl bash completion
  copy:
    src: kubectl_bash_completion.sh
    dest: /etc/bash_completion.d/kubectl.sh
  when: ansible_os_family in ["Debian","RedHat"]

- name: Copy kubectl from hyperkube container
  command: "/usr/bin/docker run --rm -v {{ bin_dir }}:/systembindir {{ hyperkube_image_repo }}:{{ hyperkube_image_tag }} /bin/cp /hyperkube /systembindir/kubectl"
  register: kube_task_result
  until: kube_task_result.rc == 0
  retries: 4
  delay: "{{ retry_stagger | random + 3 }}"
  changed_when: false

- include: system-pods.yml
  when: ({{ not use_kubeadm|bool }})

# TODO(bogdando) kubeadm init/update pods on RedHat/CoreOS
- include: kube-init.yml
  when: (ansible_os_family in ["Debian"]) and ({{ use_kubeadm|bool }}) and (inventory_hostname == groups['kube-master'][0])
  run_once: true

- include: kubeadm-system-pods.yml
  when: (ansible_os_family in ["Debian"]) and ({{ use_kubeadm|bool }})
