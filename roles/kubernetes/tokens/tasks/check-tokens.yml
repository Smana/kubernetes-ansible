---
- name: "Check_tokens | check if the tokens have already been generated on first master"
  stat:
    path: "{{ kube_token_dir }}/known_tokens.csv"
    get_attributes: no
    get_checksum: yes
    get_mime: no
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  register: known_tokens_master
  run_once: true

- name: "Check_tokens | Declare 'sync_tokens' and 'gen_tokens' with default false"
  set_fact:
    sync_tokens: false
    gen_tokens: false
  run_once: true    

- name: "Check_tokens | Set 'gen_tokens' and 'sync_tokens' to true if tokens are not exist on first master"
  set_fact:
    gen_tokens: true
    sync_tokens: true
  when: not known_tokens_master.stat.exists
  run_once: true

- name: "Check tokens | check if a cert already exists"
  stat:
    path: "{{ kube_token_dir }}/known_tokens.csv"
    get_attributes: no
    get_checksum: yes
    get_mime: no
  register: known_tokens
  when:
    - inventory_hostname in groups['kube_control_plane']
    - inventory_hostname != groups['kube_control_plane']|first
    - not gen_tokens  

- name: "Check_tokens | Set 'sync_tokens' to true"
  set_fact:
    sync_tokens: true
  when:
    - inventory_hostname in groups['kube_control_plane']
    - inventory_hostname != groups['kube_control_plane']|first
    - not gen_tokens
    - not known_tokens.stat.exists or known_tokens.stat.checksum |default('')!=known_tokens_master.stat.checksum|default('')   
