---
- include: set_facts.yml

- name: Install | Copy etcdctl binary from container
  command: sh -c "/usr/bin/docker rm -f etcdctl-binarycopy;
           /usr/bin/docker create --name etcdctl-binarycopy {{ etcd_image_repo }}:{{ etcd_image_tag }} &&
           /usr/bin/docker cp etcdctl-binarycopy:{{ etcd_container_bin_dir }}etcdctl {{ bin_dir }}/etcdctl &&
           /usr/bin/docker rm -f etcdctl-binarycopy"
  changed_when: false

- include: set_cluster_health.yml

- include: configure.yml

- include: refresh_config.yml

# Reload systemd before starting service
- meta: flush_handlers

- name: Ensure etcd is running
  service:
    name: etcd
    state: started
    enabled: yes

# After etcd cluster is assembled, make sure that
# initial state of the cluster is in `existing`
# state insted of `new`.
- include: set_cluster_health.yml
- include: refresh_config.yml
