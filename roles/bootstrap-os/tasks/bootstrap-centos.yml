---

- name: Check presence of fastestmirror.conf
  stat:
    path: /etc/yum/pluginconf.d/fastestmirror.conf
  register: fastestmirror

# fastestmirror plugin actually slows down Ansible deployments
- name: Disable fastestmirror plugin
  lineinfile:
    dest: /etc/yum/pluginconf.d/fastestmirror.conf
    regexp: "^enabled=.*"
    line: "enabled=0"
    state: present
  when: fastestmirror.stat.exists

- name: Check whether CentOS-Base.repo contains "mirrorlist.centos.org"
  command: grep -Fq "mirrorlist.centos.org" /etc/yum.repos.d/CentOS-Base.repo
  register: centos_base_repo_have_centos_org
  check_mode: no
  ignore_errors: yes
  changed_when: no

- name: Add proxy to [base] in /etc/yum.repos.d/CentOS-Base.repo if contains "mirrorlist.centos.org"
  lineinfile:
    dest: "/etc/yum.repos.d/CentOS-Base.repo"
    line: "proxy={{http_proxy}}"
    insertafter: '^\[base\]'
    state: present
  when: centos_base_repo_have_centos_org.rc == 0

- name: Add proxy to [updates] in /etc/yum.repos.d/CentOS-Base.repo if contains "mirrorlist.centos.org"
  lineinfile:
    dest: "/etc/yum.repos.d/CentOS-Base.repo"
    line: "proxy={{http_proxy}}"
    insertafter: '^\[updates\]'
    state: present
  when: centos_base_repo_have_centos_org.rc == 0

- name: Add proxy to [addons] in /etc/yum.repos.d/CentOS-Base.repo if contains "mirrorlist.centos.org"
  lineinfile:
    dest: "/etc/yum.repos.d/CentOS-Base.repo"
    line: "proxy={{http_proxy}}"
    insertafter: '^\[addons\]'
    state: present
  when: centos_base_repo_have_centos_org.rc == 0

- name: Add proxy to [extras] in /etc/yum.repos.d/CentOS-Base.repo if contains "mirrorlist.centos.org"
  lineinfile:
    dest: "/etc/yum.repos.d/CentOS-Base.repo"
    line: "proxy={{http_proxy}}"
    insertafter: '^\[extras\]'
    state: present
  when: centos_base_repo_have_centos_org.rc == 0

- name: Install packages requirements for bootstrap
  yum:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - libselinux-python
      - epel-release

- name: Check whether epel.repo contains "mirrors.fedoraproject.org"
  command: grep -Fq "mirrors.fedoraproject.org" /etc/yum.repos.d/epel.repo
  register: epel_repo_have_fedoraproject_org
  check_mode: no
  ignore_errors: yes
  changed_when: no

- name: Add proxy to [epel] in /etc/yum.repos.d/epel.repo if contains "mirrors.fedoraproject.org"
  lineinfile:
    dest: "/etc/yum.repos.d/epel.repo"
    line: "proxy={{http_proxy}}"
    insertafter: '^\[epel\]'
    state: present
  when: epel_repo_have_fedoraproject_org.rc == 0

- name: Install pip for bootstrap
  yum:
    name: python-pip
    state: present
