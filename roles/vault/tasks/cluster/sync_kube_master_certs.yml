---

- name: cluster/sync_kube_master_certs | Create list of needed certs
  set_fact:
    vault_kube_master_cert_list: >-
        {{  vault_kube_master_cert_list|default([]) + [
        "admin-" + item + ".pem",
        "apiserver-" + item + ".pem"
        ] }}
  with_items: "{{ groups['kube-master'] }}"

- include: ../sync_file.yml
  vars: 
    sync_file: "{{ item }}"
    sync_file_dir: "{{ kube_cert_dir }}"
    sync_file_hosts: "{{ groups['kube-master'] }}"
    sync_file_is_cert: true
  with_items: "{{ vault_kube_master_cert_list|default([]) }}"

- name: cluster/sync_kube_master_certs | Set facts for kube-master sync_file results
  set_fact:
    vault_kube_master_certs_needed: "{{ vault_kube_master_certs_needed|default([]) + [item.path] }}"
  with_items: "{{ sync_file_results }}"
  when: item.no_srcs|bool

- name: cluster/sync_kube_master_certs | Unset sync_file_results after kube master certs
  set_fact:
    sync_file_results: []

- include: ../sync_file.yml
  vars: 
    sync_file: ca.pem
    sync_file_dir: "{{ kube_cert_dir }}"
    sync_file_hosts: "{{ groups['kube-master'] }}"

- name: cluster/sync_kube_master_certs | Unset sync_file_results after ca.pem
  set_fact:
    sync_file_results: []
