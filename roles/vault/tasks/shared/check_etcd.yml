---
- name: check_etcd | Check if certificates are present
  shell: ls -ld "{{ etcd_cert_dir }}/node-{{ inventory_hostname }}.pem"
  register: cert_present
  ignore_errors: yes

- name: check_etcd | When etcd certs are missing, etcd cannot be available
  set_fact:
    vault_etcd_available: false
  when: cert_present.rc != 0

- name: check_etcd | Check if etcd is up and reachable
  uri:
    url: "{{ vault_etcd_url.split(',')[0] }}/health"
    validate_certs: no
    client_cert: "{{ etcd_cert_dir }}/node-{{ inventory_hostname }}.pem"
    client_key: "{{ etcd_cert_dir }}/node-{{ inventory_hostname }}-key.pem"
    return_content: yes
  until: vault_etcd_health_check.status == 200 or vault_etcd_health_check.status == 401
  retries: 3
  delay: 2
  delegate_to: "{{groups['etcd'][0]}}"
  run_once: true
  failed_when: false
  register: vault_etcd_health_check
  when: cert_present.rc == 0

- name: check_etcd | Set fact based off the etcd_health_check response
  set_fact:
    vault_etcd_available: "{{ vault_etcd_health_check.content  }}"
  when: cert_present == 0

- set_fact:
    vault_etcd_available: "{{ vault_etcd_available.health|d()|bool }}"
  when: cert_present == 0

- name: check_etcd | Fail if etcd is not available and needed
  fail:
    msg: >
         Unable to start Vault cluster! Etcd is not available at
         {{ vault_etcd_url }} however it is needed by Vault as a backend.
  when: vault_etcd_needed|d() and not vault_etcd_available
