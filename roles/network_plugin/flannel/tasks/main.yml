---
- name: Flannel | Write flannel configuration
  template:
    src: network.json
    dest: /etc/flannel-network.json
    backup: yes

- name: Flannel | Create flannel pod manifest
  template:
    src: flannel-pod.yml
    dest: /etc/kubernetes/manifests/flannel-pod.manifest
  notify: delete default docker bridge

- name: Flannel | Wait for flannel subnet.env file presence
  wait_for:
    path: /run/flannel/subnet.env
    delay: 5
    timeout: 600

- name: Flannel | Get flannel_subnet from subnet.env
  shell: cat /run/flannel/subnet.env | awk -F'=' '$1 == "FLANNEL_SUBNET" {print $2}'
  register: flannel_subnet_output
  changed_when: false

- set_fact:
    flannel_subnet: "{{ flannel_subnet_output.stdout }}"

- name: Flannel | Get flannel_mtu from subnet.env
  shell: cat /run/flannel/subnet.env | awk -F'=' '$1 == "FLANNEL_MTU" {print $2}'
  register: flannel_mtu_output
  changed_when: false

- set_fact:
    flannel_mtu: "{{ flannel_mtu_output.stdout }}"

- name: Flannel | Set docker daemon options for Debian/CoreOS
  lineinfile:
    dest: /etc/default/docker
    regexp: "# NETWORK_OVERLAY"
    line: "DOCKER_OPTS=\"$DOCKER_OPTS --bip={{ flannel_subnet }} --mtu={{ flannel_mtu }}\" # NETWORK_OVERLAY"
  when: ansible_os_family == "Debian" or ansible_os_family == "CoreOS"
  notify:
    - restart docker

- name: Flannel | Set docker daemon options for redhat
  lineinfile:
    dest: /etc/default/docker
    regexp: "# NETWORK_OVERLAY"
    line: "OPTIONS=\"$OPTIONS --bip={{ flannel_subnet }} --mtu={{ flannel_mtu }}\" # NETWORK_OVERLAY"
  when: ansible_os_family == "RedHat"
  notify:
    - restart docker

- name: Flannel | Create docker config symlink for CoreOS
  file:
    src: "/etc/default/docker"
    dest: "/run/flannel_docker_opts.env"
    state: link
  when: ansible_os_family == "CoreOS"

- meta: flush_handlers
