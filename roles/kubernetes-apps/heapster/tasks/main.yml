---
# tasks file for heapster_grafana
- name: Heapster Grafana Influxdb | Delete manifests
  kube:
    name: "heapster_grafana"
    namespace: "{{ heapster_namespace }}"
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/addons/heapster/"
    state: "absent"
  ignore_errors: yes
  when:
    - inventory_hostname == groups['kube-master'][0]

- name: Heapster Grafana Influxdb | Remove legacy addon dir and manifests
  file:
    path: "{{ kube_config_dir }}/addons/heapster"
    state: absent
  when:
    - inventory_hostname == groups['kube-master'][0]
  tags:
    - upgrade

- name: Heapster Grafana Influxdb | Create addon dir
  file:
    path: "{{ kube_config_dir }}/addons/heapster"
    state: directory
    owner: root
    group: root
    mode: 0755
  when:
    - inventory_hostname == groups['kube-master'][0]

- name: Heapster Grafana Influxdb | Templates list
  set_fact:
    heapster_grafana_templates:
      - { name: grafana, file: grafana.yaml }
      - { name: heapster-rbac, file: heapster-rbac.yaml }
      - { name: heapster, file: heapster.yaml }
      - { name: influxdb, file: influxdb.yaml }

- name: Heapster Grafana Influxdb | Create manifests
  template:
    src: "{{ item.file }}.j2"
    dest: "{{ kube_config_dir }}/addons/heapster/{{ item.file }}"
  with_items: "{{ heapster_grafana_templates }}"
  register: heapster_grafana_manifests
  when:
    - inventory_hostname == groups['kube-master'][0]

- name: Heapster Grafana Influxdb | Apply manifests
  kube:
    name: "{{ item.item.name }}"
    namespace: "{{ heapster_namespace }}"
    kubectl: "{{ bin_dir }}/kubectl"
    filename: "{{ kube_config_dir }}/addons/heapster/{{ item.item.file }}"
    state: "latest"
  with_items: "{{ heapster_grafana_manifests.results }}"
  when:
    - inventory_hostname == groups['kube-master'][0]
