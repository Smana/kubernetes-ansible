---
- name: Template vm files for CI job
  template:
    src: "vm.yml.j2"
    dest: "/tmp/{{ test_name }}/instance-{{ vm_id }}.yml"
  vars:
    vm_name: "instance-{{ vm_id }}"
  loop: "{{ range(0, vm_count|int, 1) | list }}"
  loop_control:
    index_var: vm_id

- name: Start vms for CI job
  k8s:
    state: present
    src: "/tmp/{{ test_name }}/instance-{{ vm_id }}.yml"
  loop: "{{ range(0, vm_count|int, 1) | list }}"
  loop_control:
    index_var: vm_id

- name: Wait for vms to have ipaddress assigned
  shell: "kubectl get vmis -n {{ test_name }} instance-{{ vm_id }} -o json | jq '.status.interfaces[].ipAddress' | tr -d '\"'"
  register: vm_ips
  loop: "{{ range(0, vm_count|int, 1) | list }}"
  loop_control:
    index_var: vm_id
  retries: 10
  delay: 15
  ignore_errors: true
  until:
    - vm_ips.stdout | ipaddr
