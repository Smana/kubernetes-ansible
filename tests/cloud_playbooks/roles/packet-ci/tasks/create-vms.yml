---
- name: Start vms for CI job
  vars:
    tvars:
      kubespray_groups: "{{ item }}"
  kubernetes.core.k8s:
    definition: "{{ lookup('template', 'vm.yml.j2', template_vars=tvars) }}"
  loop: "{{ scenarios[mode | d('default')] }}"

- name: Wait for vms to have IP addresses
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachineInstance
    label_selectors:
      - "ci_job_id={{ ci_job_id }}"
    namespace: "{{ pod_namespace }}"
  register: vmis
  until: vmis.resources
          | map(attribute='status.interfaces.0')
          | rejectattr('ipAddress', 'defined') == []
  retries: 30
  delay: 10

- name: "Create inventory for CI tests"
  template:
    src: "inv.kubevirt.yml.j2"
    dest: "{{ inventory_path }}/inv.kubevirt.yml"
    mode: "0644"
