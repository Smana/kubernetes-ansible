---
- hosts: localhost
  become: false
  gather_facts: no
  vars:
    vms_dir: /images/vms
    ci_job_name: "{{ lookup('env', 'CI_JOB_NAME') }}"
  tasks:

    - name: include vars for test {{ ci_job_name }}
      include_vars: "../files/{{ ci_job_name }}.yml"

    - name: replace_test_id
      set_fact:
        test_name: "{{ test_id | regex_replace('\\.', '-') }}"

    - name: set inventory
      set_fact:
        inventories: "{{ lookup('template', 'vars/inventory-modes.yml') | from_yaml}}"
        deploy_modes:
          '3':
            - {name: "k8s-{{test_name}}-1"}
            - {name: "k8s-{{test_name}}-2"}
            - {name: "k8s-{{test_name}}-3"}
          '2':
            - {name: "k8s-{{test_name}}-1"}
            - {name: "k8s-{{test_name}}-2"}
          '1':
            - {name: "k8s-{{test_name}}-1"}

    - name: show vars
      debug: msg="{{deploy_modes.keys()}}"

    - name: show vars
      debug: msg="{{inventories}}"

    - set_fact:
        vms: "{{deploy_modes[vmcount]}}"
        gen_inventory: "{{inventories['inventories'][mode]}}"

    - name: show vars
      debug: var=vms

    - name: show vars
      debug: var=gen_inventory


#    - name: start-vm
#      include_role:
#        name:  kubespray-ci
#      tags:
#        - start-vm
#      when: action|default("start") == "start"

#    - name: stop-vm
#      command: kubectl delete vmirs k8s-{{test_name}} -n gitlab-runner
#      when:
#        - action|default("start") == "destroy"
#      tags:
#        - stop-vm
